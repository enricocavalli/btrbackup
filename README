INTRODUZIONE


DIPENDENZE

Il software dipende da

rsync >= 3.0.7
mutt
debianutils (per savelog)
procmail (per lockfile)
bash (recente, senz'altro >=3)


INSTALLAZIONE

1. Inizializzare il filesystem btrfs

Il filesystem btrfs viene inizializzato senza opzioni particolari, ma è
opportuno montarlo con le opzioni compress e noatime per questioni di
occupazione spazio disco e performance.

mkfs.btrfs /dev/sdb
mkdir /rsbackup
mount -o compress,noatime,nodiratime /dev/sdb /rsbackup

Aggiungere  la riga corrispondente in /etc/fstab

2. Generare  una chiave per l'autenticazione sui server da backuppare

cd etc/
ssh-keygen  -t dsa -C rsbackup-key -f chiave.dsa

Copiare la parte pubblica della chiave nello script di configurazione dei
client (vedi contrib/config-client.sh)

CONFIGURAZIONE DI UN SERVER DA BACKUPPARE

Sui server da backuppare deve essere creato un utente rsbackup in grado
di eseguire rsync come utente root (tramite sudo).

Il server deve accettare connessioni ssh dal server di backup e deve accettare
connessioni ssh autenticate con la chiave generata in precedenza. Si veda
contrib/config-client.sh per un esempio di configurazione. Adattare in base
alle proprie specifiche esigenze.

Lato server di backup viene semplicemente fatto girare il comando addserver.sh
che si occupa di inizializzare il filesystem di base su cui andranno i backup
e crea le entry in /etc/exports per esportare via nfs gli snapshot (in sola
lettura) e i file di configurazione per i filesystem da incluedere e le
eventuali esclusioni (in lettura/scrittura, per consentire personalizzazione 
autonoma di questi dati).

addserver.sh accetta tre argomenti: l'hostname o ip del server da backuppare,
il nome che vogliamo dare al file di configurazione del server (si riflette
anche sulla directory in cui vengono creati gli snapshot) e opzionalmente
un indirizzo email per notificare all'amministratore del server l'esito dei 
backup

addserver.sh accetta tre argomenti: l'hostname o ip del server da backuppare,
il nome che vogliamo dare al file di configurazione del server (si riflette
anche sulla directory in cui vengono creati gli snapshot) e opzionalmente
un indirizzo email per notificare all'amministratore del server l'esito dei 
backup

NOTE SU INCLUSIONI ED ESCLUSIONI

Per quanto riguarda gli include, si possono backuppare solo certe parti di
macchina, ad esempio inserendo in filesystems.conf

/etc/asterisk
/usr/local

vengono backuppate quelle due sole directory. Per via delle opzioni --files-from
e dell'rsync che parte dal ramo "/", il tutto risulta comunque backuppato sotto
il percorso completo, ad esempio

/rsbackup/macchina/.work/etc/asterisk

Per questo è possibile aggiungere mano a mano che lo si desidera parti di
filesystem che si vogliono mettere sotto backup, senza problemi di struttura
dell'albero delle directory sotto /rsbackup/macchina/,

Per quanto riguarda le esclusioni (specificabili in excludes.conf), prestare
attenzione alla diversità delle due sintassi possibili:

voicemail/

voicemail/**

La prima non crea nemmeno la directory voicemail, la seconda crea la directory
ma non backuppa niente del suo contenuto. Tutto sta nel capire se si vuole
mantenere la struttura completa sotto backup, eventaulmente senza contentuo.
Nel dubbio conviene usare la seconda specifica.


VARIE ED EVENTUALI

Per impedire a mutt di salvare la posta in uscita usare

# more .muttrc
set record="/dev/null"
